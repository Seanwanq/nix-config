# TPM 2.0 è‡ªåŠ¨è§£é” LUKS åŠ å¯†ç£ç›˜é…ç½®æŒ‡å—

## æ¦‚è¿°

ä½¿ç”¨ TPM 2.0 èŠ¯ç‰‡å­˜å‚¨ LUKS è§£å¯†å¯†é’¥ï¼Œå®ç°å¼€æœºè‡ªåŠ¨è§£é”ï¼Œåªéœ€åœ¨æ¡Œé¢ç™»å½•æ—¶è¾“å…¥å¯†ç ã€‚

## ä¼˜åŠ¿

âœ… **æ›´å®‰å…¨**: å¯†é’¥å­˜å‚¨åœ¨ TPM èŠ¯ç‰‡ä¸­ï¼Œæ¯”å¯†ç æ›´å®‰å…¨  
âœ… **æ›´ä¼˜é›…**: å¼€æœºæ—¶è‡ªåŠ¨è§£é”ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥å¯†ç   
âœ… **ä»ç„¶éœ€è¦ç™»å½•**: åˆ°è¾¾æ¡Œé¢åä»éœ€è¾“å…¥ç”¨æˆ·å¯†ç ç™»å½•  
âœ… **é˜²ç¯¡æ”¹**: TPM ä¼šæ£€æµ‹ BIOS/å›ºä»¶/å¼•å¯¼åŠ è½½å™¨çš„å˜åŒ–ï¼Œå¦‚æœè¢«ç¯¡æ”¹ä¼šæ‹’ç»è§£é”

## å‰ç½®è¦æ±‚

1. **TPM 2.0 èŠ¯ç‰‡** - Dell G15 é»˜è®¤é…å¤‡
2. **å·²å¯ç”¨ LUKS åŠ å¯†** - æ‚¨å·²ç»é…ç½®å¥½
3. **systemd-boot å¼•å¯¼åŠ è½½å™¨** - æ‚¨å·²ç»åœ¨ä½¿ç”¨

## é…ç½®æ­¥éª¤

### 1. å¯¼å…¥ TPM æ¨¡å—

ç¼–è¾‘ `/home/sean/Projects/nix-config/hosts/dell-g15/default.nix`ï¼Œåœ¨ `imports` éƒ¨åˆ†æ·»åŠ ï¼š

```nix
imports = [
  ../../modules/system.nix
  ../../modules/power-management.nix
  ../../modules/tpm-luks.nix        # ğŸ‘ˆ æ·»åŠ è¿™ä¸€è¡Œ
  ../../modules/niri.nix
  ../../modules/gnome.nix
  ./hardware-configuration.nix
];
```

### 2. é‡å»ºç³»ç»Ÿ

```bash
just build-g15
```

### 3. æ£€æŸ¥ TPM æ˜¯å¦å¯ç”¨

é‡å¯åï¼Œæ£€æŸ¥ TPM çŠ¶æ€ï¼š

```bash
# æ£€æŸ¥ TPM è®¾å¤‡
ls -la /dev/tpm*

# åº”è¯¥çœ‹åˆ°:
# /dev/tpm0
# /dev/tpmrm0

# æŸ¥çœ‹ TPM ä¿¡æ¯
sudo tpm2_getcap properties-fixed
```

### 4. æŸ¥æ‰¾æ‚¨çš„ LUKS è®¾å¤‡ UUID

æ¯å°ç”µè„‘çš„ LUKS è®¾å¤‡ UUID éƒ½ä¸åŒã€‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•æŸ¥æ‰¾ï¼š

#### ğŸš€ å¿«é€Ÿæ–¹æ³•ï¼šä½¿ç”¨è¾…åŠ©è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿è¡ŒæŸ¥æ‰¾è„šæœ¬
./find-luks-uuid.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨å¤šç§æ–¹æ³•æŸ¥æ‰¾æ‚¨çš„ LUKS UUIDï¼Œå¹¶ç»™å‡ºå¯ä»¥ç›´æ¥ä½¿ç”¨çš„å‘½ä»¤ã€‚

#### æ–¹æ³• 1ï¼šä» hardware-configuration.nix æŸ¥æ‰¾

```bash
# æŸ¥çœ‹ç¡¬ä»¶é…ç½®æ–‡ä»¶
cat /etc/nixos/hardware-configuration.nix | grep luks
```

æ‚¨ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š
```nix
boot.initrd.luks.devices."luks-52846d5d-f14e-4e5f-a167-fe1ff015b9ca".device = "/dev/disk/by-uuid/52846d5d-f14e-4e5f-a167-fe1ff015b9ca";
```

å…¶ä¸­ `52846d5d-f14e-4e5f-a167-fe1ff015b9ca` å°±æ˜¯æ‚¨çš„ LUKS UUIDã€‚

#### æ–¹æ³• 2ï¼šä½¿ç”¨ lsblk å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰å—è®¾å¤‡
lsblk -f
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
NAME        FSTYPE      LABEL UUID                                 MOUNTPOINT
nvme0n1                                                             
â”œâ”€nvme0n1p1 vfat              E623-8214                            /boot
â””â”€nvme0n1p2 crypto_LUKS       52846d5d-f14e-4e5f-a167-fe1ff015b9ca 
  â””â”€luks... ext4              1ff0b5ba-18e1-43db-8616-ea0b25e00867 /
```

æ‰¾åˆ° `FSTYPE` ä¸º `crypto_LUKS` çš„è¡Œï¼Œå…¶ UUID å°±æ˜¯ LUKS è®¾å¤‡çš„ UUIDã€‚

#### æ–¹æ³• 3ï¼šä½¿ç”¨ blkid å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰å—è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆéœ€è¦ root æƒé™ï¼‰
sudo blkid | grep crypto_LUKS
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
/dev/nvme0n1p2: UUID="52846d5d-f14e-4e5f-a167-fe1ff015b9ca" TYPE="crypto_LUKS"
```

#### æ–¹æ³• 4ï¼šæŸ¥çœ‹å½“å‰è§£é”çš„ LUKS è®¾å¤‡

```bash
# æŸ¥çœ‹ /dev/mapper ä¸­çš„è®¾å¤‡
ls -la /dev/mapper/

# æŸ¥çœ‹ cryptsetup çŠ¶æ€
sudo cryptsetup status /dev/mapper/luks-*
```

### 5. æ³¨å†Œ LUKS å¯†é’¥åˆ° TPM

ä½¿ç”¨ä¸Šé¢æ‰¾åˆ°çš„ UUIDï¼Œå°†å¯†ç æ³¨å†Œåˆ° TPMï¼š

```bash
# æ›¿æ¢ä¸‹é¢çš„ UUID ä¸ºæ‚¨è‡ªå·±çš„ UUID
LUKS_UUID="52846d5d-f14e-4e5f-a167-fe1ff015b9ca"

# å°†ç°æœ‰å¯†ç æ³¨å†Œåˆ° TPM
sudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+7 /dev/disk/by-uuid/$LUKS_UUID
```

**æ›´ç®€å•çš„æ–¹æ³•** - ç›´æ¥ä½¿ç”¨è®¾å¤‡è·¯å¾„ï¼š

```bash
# å¦‚æœæ‚¨çŸ¥é“åŠ å¯†åˆ†åŒºåœ¨å“ªé‡Œï¼ˆé€šå¸¸æ˜¯ nvme0n1p2 æˆ– sda2ï¼‰
sudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+7 /dev/nvme0n1p2
```

**æ‰§è¡Œè¿‡ç¨‹**:
1. ç³»ç»Ÿä¼šæç¤ºè¾“å…¥å½“å‰çš„ LUKS å¯†ç 
2. è¾“å…¥å¯†ç åï¼Œå¯†é’¥ä¼šè¢«å­˜å‚¨åˆ° TPM ä¸­
3. å®Œæˆåï¼ŒTPM è§£é”æ–¹å¼ä¼šè¢«æ·»åŠ ï¼ˆåŸå¯†ç ä»ç„¶æœ‰æ•ˆï¼‰

**PCR è¯´æ˜**:
- `PCR 0`: å›ºä»¶ä»£ç ï¼ˆBIOS/UEFIï¼‰
- `PCR 7`: å®‰å…¨å¯åŠ¨çŠ¶æ€
- ä½¿ç”¨è¿™ä¸¤ä¸ª PCR ç¡®ä¿ç³»ç»Ÿæœªè¢«ç¯¡æ”¹æ—¶æ‰èƒ½è§£é”

### 6. éªŒè¯ TPM å¯†é’¥å·²æ³¨å†Œ

```bash
# æ›¿æ¢ä¸ºæ‚¨çš„ UUID æˆ–ç›´æ¥ä½¿ç”¨è®¾å¤‡è·¯å¾„
sudo cryptsetup luksDump /dev/disk/by-uuid/æ‚¨çš„UUID | grep -A 5 "systemd-tpm2"

# æˆ–è€…ä½¿ç”¨è®¾å¤‡è·¯å¾„
sudo cryptsetup luksDump /dev/nvme0n1p2 | grep -A 5 "systemd-tpm2"
```

æ‚¨åº”è¯¥çœ‹åˆ°ä¸€ä¸ªä½¿ç”¨ systemd-tpm2 çš„å¯†é’¥æ§½ã€‚

**å®Œæ•´æŸ¥çœ‹æ‰€æœ‰å¯†é’¥æ§½**ï¼š

```bash
sudo cryptsetup luksDump /dev/nvme0n1p2
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
LUKS header information
Version:        2
...
Keyslots:
  0: luks2
      Key:        512 bits
      ...
  1: systemd-tpm2
      Key:        512 bits
      ...
```

### 7. æµ‹è¯•è‡ªåŠ¨è§£é”

é‡å¯ç³»ç»Ÿï¼š

```bash
sudo reboot
```

**é¢„æœŸè¡Œä¸º**:
- âœ… å¼€æœºæ—¶**ä¸å†æç¤º**è¾“å…¥ LUKS å¯†ç 
- âœ… ç›´æ¥è¿›å…¥å¼•å¯¼åŠ è½½å™¨ï¼ˆsystemd-bootï¼‰
- âœ… è‡ªåŠ¨åŠ è½½ç³»ç»Ÿ
- âœ… åˆ°è¾¾ç™»å½•ç•Œé¢åè¾“å…¥**ç”¨æˆ·å¯†ç **ç™»å½•

## å®‰å…¨è€ƒè™‘

### âœ… è¿™ä¸ªæ–¹æ¡ˆå®‰å…¨å—ï¼Ÿ

**æ˜¯çš„ï¼Œè€Œä¸”æ¯”å•çº¯çš„å¯†ç æ›´å®‰å…¨ï¼**

1. **ç‰©ç†å®‰å…¨**: å¯†é’¥å­˜å‚¨åœ¨ TPM èŠ¯ç‰‡ä¸­ï¼Œæ— æ³•ç›´æ¥è¯»å–
2. **é˜²ç¯¡æ”¹**: å¦‚æœæœ‰äººä¿®æ”¹äº† BIOSã€å¼•å¯¼åŠ è½½å™¨æˆ–å†…æ ¸ï¼ŒTPM ä¼šæ£€æµ‹åˆ° PCR å€¼å˜åŒ–ï¼Œæ‹’ç»è§£é”
3. **ä»éœ€ç™»å½•**: è¿›å…¥ç³»ç»Ÿåä»éœ€è¾“å…¥ç”¨æˆ·å¯†ç ï¼Œæœªæˆæƒè€…æ— æ³•è®¿é—®æ‚¨çš„æ•°æ®
4. **å¤šé‡ä¿æŠ¤**: æ‚¨ä»ç„¶ä¿ç•™åŸå§‹å¯†ç ï¼Œå¯ä»¥åœ¨ TPM å¤±è´¥æ—¶ä½¿ç”¨

### ä»€ä¹ˆæƒ…å†µä¸‹ TPM è§£é”ä¼šå¤±è´¥ï¼Ÿ

TPM è§£é”ä¼šåœ¨ä»¥ä¸‹æƒ…å†µå¤±è´¥ï¼ˆéœ€è¦æ‰‹åŠ¨è¾“å…¥å¯†ç ï¼‰ï¼š

- ğŸ”§ æ›´æ–°äº† BIOS/UEFI å›ºä»¶
- ğŸ”§ ä¿®æ”¹äº† BIOS è®¾ç½®ï¼ˆå°¤å…¶æ˜¯å®‰å…¨å¯åŠ¨ç›¸å…³ï¼‰
- ğŸ”§ æ›´æ¢äº†ä¸»æ¿æˆ– TPM èŠ¯ç‰‡
- ğŸ”§ æœ‰äººè¯•å›¾ç¯¡æ”¹å¼•å¯¼åŠ è½½å™¨

**è¿™äº›éƒ½æ˜¯æœŸæœ›çš„è¡Œä¸ºï¼** è¯´æ˜ TPM æ­£åœ¨ä¿æŠ¤æ‚¨çš„ç³»ç»Ÿã€‚

### å¦‚æœ TPM è§£é”å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

ä¸ç”¨æ‹…å¿ƒï¼ç³»ç»Ÿä¼šå›é€€åˆ°å¯†ç è¾“å…¥ï¼š

1. TPM è§£é”å¤±è´¥æ—¶ï¼Œä¼šè‡ªåŠ¨æç¤ºè¾“å…¥ LUKS å¯†ç 
2. è¾“å…¥æ‚¨æœ€åˆè®¾ç½®çš„å¯†ç å³å¯
3. è¿›å…¥ç³»ç»Ÿåï¼Œé‡æ–°æ³¨å†Œ TPM å¯†é’¥ï¼ˆæ­¥éª¤ 4ï¼‰

## é«˜çº§é€‰é¡¹

### ä½¿ç”¨ä¸åŒçš„ PCR ç»„åˆ

å¦‚æœæ‚¨ä¸ä½¿ç”¨å®‰å…¨å¯åŠ¨ï¼Œå¯ä»¥åªä½¿ç”¨ PCR 0 å’Œ 7ï¼š

```bash
sudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+7 /dev/disk/by-uuid/52846d5d-f14e-4e5f-a167-fe1ff015b9ca
```

**å…¶ä»–å¸¸ç”¨ PCR ç»„åˆ**:

- `0+7`: BIOS + å®‰å…¨å¯åŠ¨ï¼ˆæ¨èï¼‰
- `0+1+2+3+7`: æ›´ä¸¥æ ¼ï¼ˆåŒ…å«ç¡¬ä»¶é…ç½®ã€å›ºä»¶ã€å¼•å¯¼åŠ è½½å™¨ç­‰ï¼‰
- `7` ä»…å®‰å…¨å¯åŠ¨çŠ¶æ€

**æ³¨æ„**: PCR è¶Šå¤šï¼Œè¶Šå®‰å…¨ï¼Œä½†ä¹Ÿè¶Šå®¹æ˜“å› ç³»ç»Ÿæ›´æ–°è€Œå¤±æ•ˆã€‚

### ç§»é™¤ TPM å¯†é’¥

å¦‚æœæ‚¨æƒ³ç¦ç”¨ TPM è‡ªåŠ¨è§£é”ï¼Œæ¢å¤åˆ°æ‰‹åŠ¨è¾“å…¥å¯†ç ï¼š

```bash
# åˆ—å‡ºæ‰€æœ‰å¯†é’¥æ§½ï¼ˆä½¿ç”¨æ‚¨çš„ UUID æˆ–è®¾å¤‡è·¯å¾„ï¼‰
sudo cryptsetup luksDump /dev/nvme0n1p2

# ç§»é™¤ TPM å¯†é’¥æ§½ï¼ˆä¾‹å¦‚æ§½ä½ 1ï¼‰
sudo systemd-cryptenroll /dev/nvme0n1p2 --wipe-slot=1
```

**âš ï¸ è­¦å‘Š**: ä¸è¦ç§»é™¤æ‚¨çš„åŸå§‹å¯†ç æ§½ï¼è‡³å°‘ä¿ç•™ä¸€ä¸ªå¯†ç æ§½ä½œä¸ºå¤‡ä»½ã€‚

### æ·»åŠ é¢å¤–çš„å¯†ç 

æ‚¨å¯ä»¥ä¿ç•™å¤šä¸ªå¯†ç æ§½ï¼š

```bash
# æ·»åŠ æ–°å¯†ç ï¼ˆä½¿ç”¨æ‚¨çš„è®¾å¤‡è·¯å¾„ï¼‰
sudo cryptsetup luksAddKey /dev/nvme0n1p2
```

è¿™æ ·æ‚¨å¯ä»¥æœ‰ï¼š
- åŸå§‹å¯†ç ï¼ˆæ§½ä½ 0ï¼‰
- TPM å¯†é’¥ï¼ˆæ§½ä½ 1ï¼‰
- å¤‡ä»½å¯†ç ï¼ˆæ§½ä½ 2ï¼‰

## æ•…éšœæ’é™¤

### TPM è®¾å¤‡ä¸å­˜åœ¨

```bash
# æ£€æŸ¥ TPM æ˜¯å¦åœ¨ BIOS ä¸­å¯ç”¨
sudo dmesg | grep -i tpm

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œè¿›å…¥ BIOS å¯ç”¨ TPM:
# Security -> TPM 2.0 Security -> Enable
```

### æ³¨å†Œå¯†é’¥æ—¶æŠ¥é”™ "TPM2 not supported"

ç¡®ä¿æ‚¨å·²ç»é‡å»ºäº†ç³»ç»Ÿå¹¶å¯ç”¨äº† TPM æ”¯æŒï¼š

```bash
# æ£€æŸ¥ systemd-cryptenroll æ˜¯å¦æ”¯æŒ TPM
systemd-cryptenroll --help | grep tpm2

# åº”è¯¥çœ‹åˆ° --tpm2-device ç­‰é€‰é¡¹
```

### æ›´æ–° BIOS åæ— æ³•è‡ªåŠ¨è§£é”

è¿™æ˜¯æ­£å¸¸çš„ï¼BIOS æ›´æ–°ä¼šæ”¹å˜ PCR å€¼ã€‚è§£å†³æ–¹æ³•ï¼š

1. æ‰‹åŠ¨è¾“å…¥ LUKS å¯†ç å¯åŠ¨ç³»ç»Ÿ
2. ç§»é™¤æ—§çš„ TPM å¯†é’¥
3. é‡æ–°æ³¨å†Œæ–°çš„ TPM å¯†é’¥

```bash
# åˆ—å‡ºå¯†é’¥æ§½ï¼ˆä½¿ç”¨æ‚¨çš„è®¾å¤‡è·¯å¾„ï¼‰
sudo cryptsetup luksDump /dev/nvme0n1p2

# ç§»é™¤æ—§çš„ TPM æ§½ï¼ˆå‡è®¾æ˜¯æ§½ä½ 1ï¼‰
sudo systemd-cryptenroll /dev/nvme0n1p2 --wipe-slot=1

# é‡æ–°æ³¨å†Œ
sudo systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+7 /dev/nvme0n1p2
```

### ä»ç„¶æç¤ºè¾“å…¥å¯†ç 

æ£€æŸ¥ initrd æ˜¯å¦æ­£ç¡®é…ç½®äº† TPM æ”¯æŒï¼š

```bash
# æŸ¥çœ‹ initrd å†…å®¹
lsinitrd /boot/initrd* | grep tpm

# åº”è¯¥çœ‹åˆ° tpm ç›¸å…³çš„æ¨¡å—å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
```

å¦‚æœæ²¡æœ‰ï¼Œç¡®ä¿ï¼š
1. `boot.initrd.systemd.enable = true`
2. `boot.initrd.systemd.enableTpm2 = true`
3. é‡å»ºç³»ç»Ÿ: `just build-g15`

## å¤‡ä»½å»ºè®®

âš ï¸ **é‡è¦**: å§‹ç»ˆä¿ç•™è‡³å°‘ä¸€ä¸ªå¯†ç æ§½ï¼

åœ¨æ³¨å†Œ TPM å‰ï¼Œå»ºè®®ï¼š

1. **è®°å½•å¯†ç **: å°† LUKS å¯†ç ä¿å­˜åœ¨å®‰å…¨çš„åœ°æ–¹ï¼ˆå¯†ç ç®¡ç†å™¨ï¼‰
2. **æ·»åŠ æ¢å¤å¯†é’¥**: åˆ›å»ºä¸€ä¸ªå¼ºå¯†ç ä½œä¸ºå¤‡ä»½
3. **ä¸è¦ç§»é™¤æ‰€æœ‰å¯†ç æ§½**: ä¿ç•™è‡³å°‘ä¸€ä¸ªå¯†ç æ§½

## æ€»ç»“

ä½¿ç”¨ TPM 2.0 è‡ªåŠ¨è§£é” LUKSï¼š

âœ… æ›´å®‰å…¨ - å¯†é’¥å­˜å‚¨åœ¨ç¡¬ä»¶ä¸­  
âœ… æ›´ä¼˜é›… - æ— éœ€åœ¨å¯åŠ¨æ—¶è¾“å…¥å¯†ç   
âœ… é˜²ç¯¡æ”¹ - æ£€æµ‹ç³»ç»Ÿä¿®æ”¹  
âœ… ä¿ç•™å¯†ç  - åŸå¯†ç ä»ç„¶æœ‰æ•ˆ  

è¿™æ˜¯ç›®å‰æœ€ä¼˜é›…ä¸”å®‰å…¨çš„ç£ç›˜åŠ å¯†è§£é”æ–¹å¼ï¼

## å‚è€ƒé“¾æ¥

- [Arch Wiki - TPM](https://wiki.archlinux.org/title/Trusted_Platform_Module)
- [systemd-cryptenroll man page](https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html)
- [NixOS TPM2 options](https://search.nixos.org/options?query=tpm2)
